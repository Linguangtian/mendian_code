<?php
 class WeixinPay { protected $appid; protected $mch_id; protected $key; protected $openid; protected $out_trade_no; protected $body; protected $total_fee; protected $identity; protected $sub_mchid; protected $attach; function __construct($appid, $openid, $mch_id, $key, $out_trade_no, $body, $total_fee, $identity, $sub_mchid, $attach = '') { goto ZwAlx; VmaBI: $this->body = $body; goto gPKLe; kucO3: $this->out_trade_no = $out_trade_no; goto VmaBI; L6Tsv: $this->openid = $openid; goto xYjr3; ZwAlx: $this->appid = $appid; goto L6Tsv; E3yi4: $this->key = $key; goto kucO3; ytnqn: $this->identity = $identity; goto Tug_6; SjluF: $this->attach = $attach; goto qDccv; gPKLe: $this->total_fee = $total_fee; goto ytnqn; Tug_6: $this->sub_mchid = $sub_mchid; goto SjluF; xYjr3: $this->mch_id = $mch_id; goto E3yi4; qDccv: } public function pay() { $return = $this->weixinapp(); return $return; } private function unifiedorder() { goto b2VVk; m4JF3: $xmlData = $this->arrayToXml($parameters); goto fkj8W; VYfrZ: $parameters["\157\x70\145\x6e\151\x64"] = $this->openid; goto p6WyI; p6WyI: S5glm: goto roqAZ; fkj8W: $return = $this->xmlToArray($this->postXmlCurl($xmlData, $url, 60)); goto ZueUQ; Doe8v: $parameters["\163\x75\x62\137\157\160\145\x6e\x69\x64"] = $this->openid; goto b5usv; IX9eA: if (!$this->attach) { goto b061l; } goto ApHjZ; ZueUQ: return $return; goto SQ4bi; VNnhF: $parameters["\x73\x69\x67\156"] = $this->getSign($parameters); goto m4JF3; b5usv: sd09H: goto IX9eA; ApHjZ: $parameters["\141\x74\164\141\x63\150"] = $this->attach; goto POvkg; roqAZ: if (!($this->identity == 2)) { goto sd09H; } goto mZgbH; oI2md: $parameters["\x73\165\142\137\155\143\x68\137\151\x64"] = $this->mch_id; goto Doe8v; t2UJ2: $parameters = array("\141\x70\x70\x69\144" => $this->appid, "\142\x6f\x64\171" => $this->body, "\155\x63\150\x5f\151\x64" => $this->mch_id, "\x6e\x6f\x6e\x63\145\137\x73\x74\x72" => $this->createNoncestr(), "\x6e\x6f\x74\151\x66\x79\137\165\x72\154" => $this->getNotifyUrl("\x2f\141\x64\144\157\x6e\x73\x2f\163\165\144\165\70\x5f\160\141\x67\x65\x2f\160\x61\171\56\x70\x68\160"), "\157\x75\164\137\x74\162\x61\144\145\x5f\x6e\x6f" => $this->out_trade_no, "\x74\x6f\x74\141\154\x5f\146\145\x65" => $this->total_fee, "\x74\162\x61\x64\x65\137\x74\171\x70\x65" => "\112\x53\101\120\x49"); goto chw1j; mZgbH: $parameters["\163\165\x62\137\141\x70\x70\151\144"] = $this->appid; goto oI2md; chw1j: if (!($this->identity == 1)) { goto S5glm; } goto VYfrZ; b2VVk: $url = "\x68\164\164\x70\x73\72\x2f\x2f\x61\x70\x69\x2e\x6d\143\150\x2e\x77\145\151\x78\x69\156\x2e\161\x71\x2e\x63\157\x6d\57\x70\141\171\x2f\165\156\151\146\151\145\144\x6f\162\144\145\x72"; goto t2UJ2; POvkg: b061l: goto VNnhF; SQ4bi: } protected function getNotifyUrl($url) { goto AFp1J; BouV6: DS0Yt: goto Tef3_; Tef3_: $current_url .= $_SERVER["\x48\x54\x54\x50\x5f\110\x4f\123\124"] . strstr($_SERVER["\122\x45\x51\125\x45\x53\x54\137\125\122\x49"], "\57\141\x70\x70\x2f\x69\156\144\145\170", true) . $url; goto snExu; oXoNh: $current_url = "\x68\164\x74\x70\163\72\57\x2f"; goto BouV6; NXBOA: if (!(isset($_SERVER["\x48\x54\124\120\x53"]) && $_SERVER["\x48\x54\124\x50\x53"] == "\x6f\156")) { goto DS0Yt; } goto oXoNh; snExu: return $current_url; goto uObco; AFp1J: $current_url = "\150\164\164\x70\72\57\x2f"; goto NXBOA; uObco: } private static function postXmlCurl($xml, $url, $second = 30) { goto H1tcF; jLSV7: curl_setopt($ch, CURLOPT_POST, TRUE); goto JcHU8; CzfwK: goto zcnXL; goto p26Y6; xsy15: $error = curl_errno($ch); goto Y6ayr; z5Q_F: curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 20); goto kO5e8; kO5e8: curl_setopt($ch, CURLOPT_TIMEOUT, 40); goto Lm1Jl; thCEe: curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE); goto jLSV7; Y6ayr: curl_close($ch); goto Kjp5s; BTBXl: if ($data) { goto E8MQs; } goto xsy15; iukOS: curl_setopt($ch, CURLOPT_URL, $url); goto hfK6o; cm7PT: $data = curl_exec($ch); goto BTBXl; hfK6o: curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); goto s3wtC; BR1Yx: curl_setopt($ch, CURLOPT_HEADER, FALSE); goto thCEe; r1ZDD: zcnXL: goto tndUl; SCLUL: return $data; goto r1ZDD; s3wtC: curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE); goto BR1Yx; xwgPb: curl_close($ch); goto SCLUL; Lm1Jl: set_time_limit(0); goto cm7PT; JcHU8: curl_setopt($ch, CURLOPT_POSTFIELDS, $xml); goto z5Q_F; Kjp5s: throw new WxPayException("\143\x75\x72\x6c\xe5\x87\xba\351\224\231\357\274\x8c\351\224\x99\350\xaf\xaf\xe7\240\201\x3a{$error}"); goto CzfwK; yGGzF: curl_setopt($ch, CURLOPT_TIMEOUT, $second); goto iukOS; p26Y6: E8MQs: goto xwgPb; H1tcF: $ch = curl_init(); goto yGGzF; tndUl: } protected function arrayToXml($arr) { goto pEMUc; MuRsE: $xml .= "\x3c\x2f\162\157\157\164\x3e"; goto k1ImS; fWWy2: foreach ($arr as $key => $val) { goto Nh36o; HMjAD: goto jF_0E; goto WvOhq; fXijG: $xml .= "\x3c" . $key . "\x3e" . arrayToXml($val) . "\74\57" . $key . "\x3e"; goto vrjx0; vrjx0: jF_0E: goto wCbFK; Bp0aL: $xml .= "\x3c" . $key . "\x3e" . $val . "\x3c\x2f" . $key . "\x3e"; goto HMjAD; WvOhq: L51a6: goto fXijG; Nh36o: if (is_array($val)) { goto L51a6; } goto Bp0aL; wCbFK: rGpbz: goto mgGkm; mgGkm: } goto NbQvZ; k1ImS: return $xml; goto NTTpb; NbQvZ: LGZIc: goto MuRsE; pEMUc: $xml = "\74\x72\157\x6f\164\76"; goto fWWy2; NTTpb: } protected function xmlToArray($xml) { goto bdjK9; F763S: return $val; goto kVnof; GXB87: $val = json_decode(json_encode($xmlstring), true); goto F763S; aFdVK: $xmlstring = simplexml_load_string($xml, "\123\x69\155\160\154\x65\x58\115\x4c\105\154\145\155\145\x6e\x74", LIBXML_NOCDATA); goto GXB87; bdjK9: libxml_disable_entity_loader(true); goto aFdVK; kVnof: } private function weixinapp() { goto ujD38; cmVww: return $parameters; goto U5Nx4; ujD38: $unifiedorder = $this->unifiedorder(); goto XORE5; OSpti: $parameters["\160\x61\171\123\151\147\x6e"] = $this->getSign($parameters); goto cmVww; XORE5: $parameters = array("\x61\x70\x70\111\144" => $this->appid, "\x74\151\155\x65\x53\x74\x61\155\160" => '' . time() . '', "\156\x6f\x6e\143\x65\x53\x74\x72" => $this->createNoncestr(), "\x70\x61\x63\x6b\141\147\x65" => "\x70\x72\x65\160\x61\x79\137\x69\x64\x3d" . $unifiedorder["\160\162\145\x70\141\171\x5f\x69\144"], "\x73\151\x67\156\124\171\x70\145" => "\x4d\x44\x35"); goto OSpti; U5Nx4: } protected function createNoncestr($length = 32) { goto uSlEa; iuMlb: $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1); goto uQvZt; Ovld9: return $str; goto K8ksl; pD2TP: $i++; goto E60Vs; z5xeL: $str = ''; goto qyycU; qyycU: $i = 0; goto EmpCf; xUnN4: xPiFG: goto Ovld9; uSlEa: $chars = "\x61\x62\143\x64\x65\146\x67\150\x69\x6a\153\154\155\x6e\157\x70\161\162\163\x74\165\x76\167\x78\x79\x7a\x30\x31\62\x33\64\65\66\x37\x38\71"; goto z5xeL; uQvZt: qoue6: goto pD2TP; E60Vs: goto UUfm2; goto xUnN4; BbOV0: if (!($i < $length)) { goto xPiFG; } goto iuMlb; EmpCf: UUfm2: goto BbOV0; K8ksl: } protected function getSign($Obj) { goto rAIXV; LfZeV: xOFH5: goto TNOyJ; iS3cf: $String = md5($String); goto OSF1I; rAIXV: foreach ($Obj as $k => $v) { $Parameters[$k] = $v; eGW90: } goto LfZeV; OSF1I: $result_ = strtoupper($String); goto re5jV; FBAI7: $String = $String . "\x26\x6b\x65\171\75" . $this->key; goto iS3cf; TNOyJ: ksort($Parameters); goto FEvJI; FEvJI: $String = $this->formatBizQueryParaMap($Parameters, false); goto FBAI7; re5jV: return $result_; goto jIxhM; jIxhM: } protected function formatBizQueryParaMap($paraMap, $urlencode) { goto TIWrc; qObcn: UHiFU: goto SSizO; EEdIs: foreach ($paraMap as $k => $v) { goto ALjB9; D0kVA: w1QOv: goto q1dMk; mkQt3: VCHeO: goto pWmSI; SSnuC: $v = urlencode($v); goto D0kVA; q1dMk: $buff .= $k . "\x3d" . $v . "\x26"; goto mkQt3; ALjB9: if (!$urlencode) { goto w1QOv; } goto SSnuC; pWmSI: } goto NTwdH; bMYVB: $reqPar = substr($buff, 0, strlen($buff) - 1); goto qObcn; RDkdy: if (!(strlen($buff) > 0)) { goto UHiFU; } goto bMYVB; TIWrc: $buff = ''; goto f62eH; f62eH: ksort($paraMap); goto EEdIs; SSizO: return $reqPar; goto P1f4t; o6THk: $reqPar; goto RDkdy; NTwdH: xww17: goto o6THk; P1f4t: } }